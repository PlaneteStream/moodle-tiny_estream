{"version":3,"file":"ui.min.js","sources":["../src/ui.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * eStream TinyMCE\n *\n * @module      tiny_estream/ui\n * @copyright   2023 Uniguest <ben.goulden@uniguest.com>\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Modal from 'tiny_estream/modal';\nimport ModalFactory from 'core/modal_factory';\nimport {getIframe} from \"./options\";\n\nexport const handleAction = (editor) => {\n    displayDialogue(editor);\n};\n\n/**\n * Get the template context for the dialogue.\n *\n * @param {Editor} editor\n * @param {object} data\n * @returns {object} data\n */\nconst getTemplateContext = (editor, data) => {\n    return Object.assign({}, {\n        iframe: getIframe(editor),\n    }, data);\n};\n\n/**\n * Split out querystring values\n *\n * @param {String} query\n * @param {String} variable\n * @returns {object} data\n */\nfunction getQS(query, variable) {\n    var vars = query.split('&');\n    for (var i = 0; i < vars.length; i++) {\n        var pair = vars[i].split('=');\n        if (decodeURIComponent(pair[0]) == variable) {\n            return decodeURIComponent(pair[1]);\n        }\n    }\n    return \"Response\";\n}\n\nconst displayDialogue = async(editor, data = {}) => {\n    const modal = await ModalFactory.create({\n        type: Modal.TYPE,\n        templateContext: getTemplateContext(editor, data),\n        large: true\n    });\n\n    modal.show();\n\n    const iframe = document.getElementById(\"PESiframe\");\n    const src = iframe.src;\n\n    if (window.addEventListener) {\n        eventMethod = 'addEventListener';\n        messageEvent = 'message';\n    } else if (window.postMessage) {\n        eventMethod = 'attachEvent';\n        messageEvent = 'onmessage';\n    } else {\n        editor.execCommand('mceInsertContent', false, \"Sorry, your web browser is not compatible with this feature.\");\n    }\n\n    var evX = window[eventMethod];\n    evX(messageEvent, function (e) {\n\n\n\n        var data = String(e.data);\n\n            if (data.indexOf(\"ID=\") > -1) {\n                if (data.indexOf(\"&source=moodle\") > -1 || data.indexOf(\"&source=Moodle\") > -1) {\n                    \n                    var pagetype = decodeURIComponent(getQS(src, \"pagetype\"));\n                    var assignmode = decodeURIComponent(getQS(src, \"assign\"));\n\n                    //if (pagetype == 'mod-assign-editsubmission' || pagetype == 'mod-assign-gradingpanel') {\n                        if (assignmode == 'true') {\n\n\n                    var title = decodeURIComponent(getQS(data, \"title\"));\n                        title = title.split(\"+\").join(\" \");\n\n                    if (data.indexOf(\"delta=\") > -1) {\n                        editor.execCommand('mceInsertContent', false, '<a href=\"'\n            + getQS(src, 'estream_url') + '/View.aspx?' + data + '\" target=\"_blank\">' + title + '</a><br><br>');\n            modal.destroy();\n                    } else {\n                        editor.execCommand('mceInsertContent', false, '<a href=\"'\n            + getQS(src, 'estream_url') + '/View.aspx?' + data + '&delta=ESDLTA\" target=\"_blank\">' + title + '</a><br><br>');\n            modal.destroy();\n                    }\n\n                    } else {\n\n                        if (getQS(src, 'estream_width', true) == \"0\" && getQS(src, 'estream_height', true) == \"0\") {\n\n                    if (data.indexOf(\"delta=\") > -1) {\n\n                        editor.execCommand('mceInsertContent', false, '<div style=\"position:relative;overflow:hidden;padding-top:56.25%;\"><iframe allow=\"autoplay; fullscreen\" allowfullscreen style=\"position:absolute;top:0;left:0;width:100%;height:100%;border:0;\" src=\"'\n                    + getQS(src, 'estream_url', true) + '/Embed.aspx?' + data + '\" ></iframe><a href=\"'\n                    + '/_planetestreamiframe_/Embed.aspx?' + data + '\">&nbsp;</a></div>');\n                    modal.destroy();\n                    } else {\n                    \n                        editor.execCommand('mceInsertContent', false, '<div style=\"position:relative;overflow:hidden;padding-top:56.25%;\"><iframe allow=\"autoplay; fullscreen\" allowfullscreen style=\"position:absolute;top:0;left:0;width:100%;height:100%;border:0;\" src=\"'\n                    + getQS(src, 'estream_url', true) + '/Embed.aspx?' + data + '&delta=ESDLTA\" ></iframe><a href=\"'\n                    + '/_planetestreamiframe_/Embed.aspx?' + data + '\">&nbsp;</a></div>');\n                    modal.destroy();\n                    }\n                         \n                    } else {\n                    \n                    if (data.indexOf(\"delta=\") > -1) {\n                    \n                        editor.execCommand('mceInsertContent', false, '<iframe allow=\"autoplay; fullscreen\" allowfullscreen style=\"width: ' + getQS(src, 'estream_width') + 'px;'\n                    + ' height: ' + getQS(src, 'estream_height') + 'px; border: 0;\" src=\"'\n                    + getQS(src, 'estream_url') + '/Embed.aspx?' + data + '\" ></iframe><a href=\"'\n                    + '/_planetestreamiframe_/Embed.aspx?' + data + '\">&nbsp;</a>');\n                    modal.destroy();\n                    } else {\n                    \n                        editor.execCommand('mceInsertContent', false, '<iframe allow=\"autoplay; fullscreen\" allowfullscreen style=\"width: ' + getQS(src, 'estream_width') + 'px;'\n                    + ' height: ' + getQS(src, 'estream_height') + 'px; border: 0;\" src=\"'\n                    + getQS(src, 'estream_url') + '/Embed.aspx?' + data + '&delta=ESDLTA\" ></iframe><a href=\"'\n                    + '/_planetestreamiframe_/Embed.aspx?' + data + '\">&nbsp;</a>');\n                    modal.destroy();\n                    }\n                    \n                    }\n                    \n                    }\n                    \n                    }\n                    }\n            \n       \n    \n  \n        \n\n    }, false);\n\n};\n"],"names":["editor","displayDialogue","getTemplateContext","data","Object","assign","iframe","getQS","query","variable","vars","split","i","length","pair","decodeURIComponent","async","modal","ModalFactory","create","type","Modal","TYPE","templateContext","large","show","src","document","getElementById","window","addEventListener","eventMethod","messageEvent","postMessage","execCommand","evX","e","String","indexOf","title","join","destroy"],"mappings":";;;;;;;4MA2B6BA,SACzBC,gBAAgBD,OAAhB,QAUEE,mBAAqB,CAACF,OAAQG,OACzBC,OAAOC,OAAO,GAAI,CACrBC,QAAQ,sBAAUN,SACnBG,eAUEI,MAAMC,MAAOC,kBACdC,KAAOF,MAAMG,MAAM,KACdC,EAAI,EAAGA,EAAIF,KAAKG,OAAQD,IAAK,KAC9BE,KAAOJ,KAAKE,GAAGD,MAAM,QACrBI,mBAAmBD,KAAK,KAAOL,gBACxBM,mBAAmBD,KAAK,UAGhC,iBAGLb,gBAAkBe,eAAMhB,YAAQG,4DAAO,SACnCc,YAAcC,uBAAaC,OAAO,CACpCC,KAAMC,eAAMC,KACZC,gBAAiBrB,mBAAmBF,OAAQG,MAC5CqB,OAAO,IAGXP,MAAMQ,aAGAC,IADSC,SAASC,eAAe,aACpBF,IAEfG,OAAOC,kBACPC,YAAc,mBACdC,aAAe,WACRH,OAAOI,aACdF,YAAc,cACdC,aAAe,aAEfhC,OAAOkC,YAAY,oBAAoB,EAAO,iEAIlDC,EADUN,OAAOE,cACbC,cAAc,SAAUI,OAIpBjC,KAAOkC,OAAOD,EAAEjC,SAEZA,KAAKmC,QAAQ,QAAU,IACnBnC,KAAKmC,QAAQ,mBAAqB,GAAKnC,KAAKmC,QAAQ,mBAAqB,GAAG,CAE7DvB,mBAAmBR,MAAMmB,IAAK,gBAIvB,QAHLX,mBAAmBR,MAAMmB,IAAK,WAGjB,KAG1Ba,MAAQxB,mBAAmBR,MAAMJ,KAAM,UACvCoC,MAAQA,MAAM5B,MAAM,KAAK6B,KAAK,KAE9BrC,KAAKmC,QAAQ,WAAa,GAC1BtC,OAAOkC,YAAY,oBAAoB,EAAO,YACxD3B,MAAMmB,IAAK,eAAiB,cAAgBvB,KAAO,qBAAuBoC,MAAQ,gBACpFtB,MAAMwB,YAEMzC,OAAOkC,YAAY,oBAAoB,EAAO,YACxD3B,MAAMmB,IAAK,eAAiB,cAAgBvB,KAAO,kCAAoCoC,MAAQ,gBACjGtB,MAAMwB,eAK+C,KAArClC,MAAMmB,IAAK,kBAAuE,KAAtCnB,MAAMmB,IAAK,kBAE3DvB,KAAKmC,QAAQ,WAAa,GAE1BtC,OAAOkC,YAAY,oBAAoB,EAAO,wMAChD3B,MAAMmB,IAAK,eAAuB,eAAiBvB,KADH,0DAETA,KAAO,sBAChDc,MAAMwB,YAGFzC,OAAOkC,YAAY,oBAAoB,EAAO,wMAChD3B,MAAMmB,IAAK,eAAuB,eAAiBvB,KADH,uEAETA,KAAO,sBAChDc,MAAMwB,WAKFtC,KAAKmC,QAAQ,WAAa,GAE1BtC,OAAOkC,YAAY,oBAAoB,EAAO,sEAAwE3B,MAAMmB,IAAK,iBAAnF,eAClCnB,MAAMmB,IAAK,kBAAoB,wBAC7CnB,MAAMmB,IAAK,eAAiB,eAAiBvB,KAFG,0DAGTA,KAAO,gBAChDc,MAAMwB,YAGFzC,OAAOkC,YAAY,oBAAoB,EAAO,sEAAwE3B,MAAMmB,IAAK,iBAAnF,eAClCnB,MAAMmB,IAAK,kBAAoB,wBAC7CnB,MAAMmB,IAAK,eAAiB,eAAiBvB,KAFG,uEAGTA,KAAO,gBAChDc,MAAMwB,eAenB"}